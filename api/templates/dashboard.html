{% extends "layout.html" %}

{% block content %}
<div class="dashboard-grid">
    <div class="section-container">
        <div class="create-user-section">
            <h3>Create New User</h3>
            <a href="/admin/create-user/{{next_user_name}}" class="btn btn-create btn-large">
                Create Next User ({{next_user_name}})
            </a>
            <p style="margin-top: 0.5rem;">Default password: "password123"</p>
        </div>

        <div>
            <h3>All Users</h3>
            <div class="scroll-container">
                {% if users.len() > 0 %}
                    {% for user in users %}
                        <div class="user-item">
                            <div class="user-info">
                                <strong>{{user.username}}</strong>
                                <br>
                                <span class="user-id">{{user.id}}</span>
                            </div>
                            <div class="button-group">
                                <a href="/admin/delete-user/{{user.id}}"
                                   onclick="return confirm('Are you sure you want to delete user {{user.username}}? This will also delete all their sessions and connections.')"
                                   class="btn btn-delete btn-small">
                                    Delete
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        No users yet
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Connection Management -->
    <div class="section-container">
        <h2 class="section-header">
            Connection Management
            <span class="section-subtitle">{{pending_connections.len()}} pending, {{accepted_connections.len()}} accepted</span>
        </h2>

        <div class="connection-create-section">
            <h3>Create Connection Request</h3>
            {% if users.len() >= 2 %}
                <div>
                    <p class="help-text">Quick connections between users:</p>
                    <div class="connection-grid">
                        {% for user_pair in user_pairs %}
                            {% if user_pair.connection_exists %}
                                <div class="connection-exists">
                                    {{user_pair.from_username}} → {{user_pair.to_username}} (exists)
                                </div>
                            {% else %}
                                <a href="/admin/create-connection/{{user_pair.from_username}}/{{user_pair.to_username}}"
                                   class="btn btn-connect">
                                    {{user_pair.from_username}} → {{user_pair.to_username}}
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <p class="help-text-small">
                        Note: Only one connection can exist between any two users (in either direction)
                    </p>
                </div>
            {% else %}
                <p class="help-text">Need at least 2 users to create connections</p>
            {% endif %}
        </div>

        <div>
            <h3>Pending Requests ({{pending_connections.len()}})</h3>
            <div class="scroll-container-small">
                {% if pending_connections.len() > 0 %}
                    {% for connection in pending_connections %}
                        <div class="connection-item">
                            <div class="connection-info">
                                <div>
                                    <strong>{{connection.initiator_username}}</strong> → <strong>{{connection.target_username}}</strong>
                                    <br>
                                    <span class="user-id">{{connection.created_at}}</span>
                                </div>
                                <span class="status-badge status-pending">Pending</span>
                            </div>
                            <div class="connection-actions">
                                <a href="/admin/accept-connection/{{connection.id}}"
                                   class="btn btn-accept">
                                    Accept
                                </a>
                                <a href="/admin/reject-connection/{{connection.id}}"
                                   class="btn btn-reject">
                                    Reject
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        No pending requests
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="section-container">
    <h2>Connections</h2>

    {% if users_with_friends.len() > 0 %}
        <div class="connections-display">
            {% for user_with_friends in users_with_friends %}
                <div class="user-card">
                    <div class="user-card-header">
                        <h3 class="user-card-title">
                            {{user_with_friends.username}}
                        </h3>
                        <p class="connection-count">
                            {{user_with_friends.friends.len()}} connection{% if user_with_friends.friends.len() != 1 %}s{% endif %}
                        </p>
                    </div>

                    <div>
                        {% for friend in user_with_friends.friends %}
                            <div class="friend-item">
                                <div class="friend-info">
                                    <div class="friend-name">
                                        {% if friend.status == "accepted" %}
                                            <span class="friend-name accepted">{{friend.username}}</span>
                                        {% else %}
                                            <span class="friend-name pending">{{friend.username}}</span>
                                        {% endif %}
                                        <p class="friend-timestamp">
                                            {% if friend.status == "accepted" %}
                                                Connected: {{friend.created_at}}
                                            {% else %}
                                                Pending since: {{friend.created_at}}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div>
                                        {% if friend.status == "accepted" %}
                                            <span class="status-badge status-friends">Friends</span>
                                        {% else %}
                                            <span class="status-badge status-pending">Pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert-info">
            <h3>No Connections Yet</h3>
            <p>No users have connected yet. Users can add friends using the <code>/api/connections</code> endpoint.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
