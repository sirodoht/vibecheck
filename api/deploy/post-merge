#!/bin/bash

# Git post-merge hook - runs after a successful merge/pull

echo "Post-merge hook: Starting cargo build --release..."

# Get the root directory of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)

# Change to the api directory
cd "$GIT_ROOT/api" || exit 1

# Check if Cargo.toml exists in the api directory
if [ ! -f "Cargo.toml" ]; then
    echo "Warning: Cargo.toml not found in api directory. Skipping build."
    exit 0
fi

# Run cargo build in release mode
if cargo build --release; then
    echo "Post-merge hook: Build completed successfully!"

    # Restart the yoapi service
    echo "Post-merge hook: Restarting yoapi service..."
    if sudo systemctl restart yoapi; then
        echo "Post-merge hook: Service restarted successfully!"
    else
        echo "Post-merge hook: Failed to restart service!"
        exit 1
    fi
else
    echo "Post-merge hook: Build failed!"
    exit 1
fi
